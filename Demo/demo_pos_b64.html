<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>POS Receipt Demo</title>
		<style>
			body {
				background: #f4f4f4;
				font-family: 'Courier New', Courier, monospace;
				display: flex;
				align-items: center;
				justify-content: center;
				min-height: 100vh;
			}
			.receipt-container {
				background: #fff;
				width: 330px;
				padding: 18px 15px;
				margin: 20px auto;
				box-shadow: 0 2px 14px rgba(0,0,0,0.10);
				border-radius: 6px;
			}
			.center { text-align: center; }
			.right  { text-align: right; }
			.bold   { font-weight: bold; }
			.small  { font-size: 13px; }
			.receipt-table {
				width: 100%;
				border-collapse: collapse;
				margin-bottom: 8px;
			}
			.receipt-table th, .receipt-table td {
				padding: 2px 0;
				font-size: 14px;
			}
			.receipt-table th {
				border-bottom: 1px solid #bbb;
			}
			hr {
				border: none;
				border-top: 1px dashed #bbb;
				margin: 8px 0;
			}
		</style>
	</head>
	<body>
		<div class="receipt-container content_to_print" id="receipt"></div>
		<script>
			// Sample data for randomization
			const companies = [
				{ name: "SEA TECH PTE LTD", addr: "99 CHANGI NORTH ST 1<br>TECHPOINT #66-88<br>Singapore 888868", tax: "201888567K" },
				{ name: "TECHMASTER SOLUTIONS PTE LTD", addr: "25 CHANGI NORTH ST 1<br>TECHPOINT #06-12<br>Singapore 498768", tax: "201234567K" },
				{ name: "FLEXITRADE SUPPLIES SDN BHD", addr: "NO 6, JALAN AMPANG<br>KUALA LUMPUR, MALAYSIA", tax: "MY0211234X" }
			];
			const items = [
				"SELF LAMINATING LABEL",
				"THERMAL PAPER ROLL",
				"BARCODE SCANNER",
				"RFID CARD",
				"RECEIPT PRINTER",
				"USB CABLE",
				"LABEL STICKER",
				"PLASTIC BAG"
			];
			const paymentTypes = [
				"CASH", "AMEX", "VISA", "MASTERCARD", "NETS", "PAYNOW", "UNIONPAY"
			];
			
			function randomEl(arr) {
				return arr[Math.floor(Math.random() * arr.length)];
			}
			
			function randomNum(min, max, decimals=2) {
				const val = Math.random() * (max - min) + min;
				return parseFloat(val.toFixed(decimals));
			}
			
			// Generate random receipt data
			const company = randomEl(companies);
			const now = new Date();
			const dtStr = now.toLocaleDateString("en-GB") + " " + now.toLocaleTimeString("en-GB", { hour12: false });
			const receiptNo = "RS" + Math.floor(Math.random()*9000 + 1000);
			const customer = "A" + Math.floor(Math.random()*90000 + 10000);
			const salesperson = "m" + String(Math.floor(Math.random()*100)).padStart(2,'0');
			const itemCount = Math.floor(Math.random()*3)+1; // 1-3 items
			let itemRows = "";
			let total = 0;
			let itemsArr = [];
			for (let i=0; i<itemCount; i++) {
				const desc = randomEl(items);
				const qty = Math.floor(Math.random()*3)+1;
				const price = randomNum(15, 160, 2);
				const amt = qty * price;
				itemsArr.push(desc);
				total += amt;
				itemRows += `<tr>
				<td colspan="2">${desc}</td>
				<td class="right">${qty}</td>
				<td class="right">${price.toFixed(2)}</td>
				<td class="right">${amt.toFixed(2)}</td>
			</tr>`;
		}
		const tax = randomNum(5, 15, 2);
		const grandTotal = total + tax;
		const paymentType = randomEl(paymentTypes);
		const paidAmt = grandTotal > 100 ? 100 : grandTotal;
		const change = paidAmt - grandTotal < 0 ? 0 : (paidAmt - grandTotal);
		
		// Receipt template
		document.getElementById('receipt').innerHTML = `
		<div class="center bold">${company.name}</div>
		<div class="center small">${company.addr}</div>
		<div class="center small">Tax Reg.#: ${company.tax}</div>
		<div class="center small">Date ${dtStr}</div><hr>
		
		<div class="small">
			Receipt#: <span class="bold">${receiptNo}</span><br>
			Customer: <span class="bold">${customer}</span><br>
			SALESPERSON: <span class="bold">${salesperson}</span>
		</div><hr>
		
		<table class="receipt-table">
			<tr>
				<th>Description</th>
				<th></th>
				<th>QTY</th>
				<th class="right">Price</th>
				<th class="right">Amount</th>
			</tr>
			${itemRows}
		</table><hr>
		
		<table style="width:100%">
			<tr>
				<td>Tax (Inclusive) :</td>
				<td class="right">${tax.toFixed(2)}</td>
			</tr>
			<tr class="bold">
				<td>Grand Total :</td>
				<td class="right">${grandTotal.toFixed(2)}</td>
			</tr>
			<tr>
				<td>${paymentType} :</td>
				<td class="right">${paidAmt.toFixed(2)}</td>
			</tr>
			<tr>
				<td>Change :</td>
				<td class="right">${change.toFixed(2)}</td>
			</tr>
		</table><hr>
		
		<div class="center bold small">Thank You, please come again ..</div>
		`;
	</script>
	
	
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script>
window.onload = function () {
	if (!navigator.userAgent.includes('HeadlessChrome')) {
		const contentDiv = document.querySelector('.content_to_print');
		if (!contentDiv) {
			console.error('No .content_to_print found!');
			return;
		}

		// Use html2canvas to convert div to image
		html2canvas(contentDiv, {
			scale: 2, // for sharpness
			useCORS: true
		}).then(canvas => {
			const imgData = canvas.toDataURL('image/png');

			// Use jsPDF to make a PDF from the image
			const { jsPDF } = window.jspdf;
			const pdf = new jsPDF({
				orientation: 'p',
				unit: 'mm',
				format: [canvas.width * 0.264583, canvas.height * 0.264583] // px to mm
			});
			pdf.addImage(
				imgData,
				'PNG',
				0,
				0,
				canvas.width * 0.264583,
				canvas.height * 0.264583
			);

			// Get base64 of PDF
			const pdfBase64 = pdf.output('datauristring').split(',')[1];

			// Send to print server
			fetch('http://localhost:3000/api/print-base64', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					base64Data: pdfBase64,
					printerName: "CutePDF Writer"
				})
			})
			.then(res => res.json())
			.then(result => {
				console.log(result.message || result);
				setTimeout(() => { window.close(); }, 500);
			})
			.catch(error => {
				console.error('Base64 Print failed:', error);
				window.close();
			});
		});
	}
};
</script>
	
</body>
</html>
